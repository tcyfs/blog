{% extends "base.html" %}
{% import "bootstrap/wtf.html" as wtf %}
{% block title %}发送私信{% endblock %}
{% block head %}
{{ super() }}
{% endblock %}

{% block page_content %}

<ul class="messages">
<li id="contectormessages" class="contector" style="list-style-type:none;">
<h1 style="text-align: center;">与{{ contector.username}}的聊天</h1>
<hr>
{% if unreadmessages==[] %}
{% for i in fmessgs %}

{% if i.author_id==contector.id %}
    {% if not i.sendto_delete %}
    <script type="text/javascript">
var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
            $(function(){
                $("#delete{{i.id}}").click(function(){
                    var data={
                        data: JSON.stringify({
                            'a': "test"
                        }),
                    }
                    $.ajax({
                        url: $SCRIPT_ROOT + '/delete_message/'+{{i.id}},
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        success:function(data){
                        $("#{{i.id}}").remove();

                        },
                      })
                    })
                })

</script>
<div id="{{i.id}}">
<div class="post-thumbnail" style="margin-top: 23px" >
<a href="{{ url_for('.user', username=i.author.username) }}">
{% if i.author.photo %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.photo }}" style="width: 40px; height: 40px; ">
{% else %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.gravatar(size=40)}}">
{% endif %}
</a>
</div>
<div class="contector-time" style="padding-left:48px; display: block;">{{ moment(i.timestamp).format('YYYY-M-D, H:mm ') }}
</div>
<div class='message-content' style="margin-left: 48px;margin-right: 75%; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color:#f5f5f5">

<div class="post-body" style="overflow-wrap: break-word;margin-left: 10px;margin-top: 5px">
{{i.body}}
</div>
<div class="input-group-btn">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="float: right;background-color: #f5f5f5;border: 0"><span class="glyphicon glyphicon-chevron-down"></span></button>
        <ul class="dropdown-menu" style="left: ;right: 0px;min-width: 20px">
          <li><button id="delete{{i.id}}" style="float: right;background-color: white;border: 0;color: #f3630b"><span class="glyphicon glyphicon-trash"></span>&nbsp;删除</button></li>
        </ul>
      </div>
</div>
</div>
    {% endif %}
{% endif %}
{% if i.sendto_id==contector.id %}
    {% if not i.author_delete %}
    <script type="text/javascript">
var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
            $(function(){
                $("#delete{{i.id}}").click(function(){
                    var data={
                        data: JSON.stringify({
                            'a': "test"
                        }),
                    }
                    $.ajax({
                        url: $SCRIPT_ROOT + '/delete_message/'+{{i.id}},
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        success:function(data){
                        $("#{{i.id}}").remove();

                        },
                      })
                    })
                })

</script>
<div id="{{i.id}}" style="display: block; margin:0;padding: 0; ">
<div class="post-thumbnail" style="margin-left:87%;margin-top: 23px">
<a href="{{ url_for('.user', username=i.author.username) }}">
{% if i.author.photo %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.photo }}" style="width: 40px; height: 40px; ">
{% else %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.gravatar(size=40)}}">
{% endif %}
</a>
</div>
<div class="contector-time" style="margin-left: 80%;margin-right:">{{ moment(i.timestamp).format('YYYY-M-D, H:mm') }}

</div>


      
<div class='message-content' style="margin-left: 75%;margin-right: 50px; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color: rgba(73, 241, 78, 0.9);">

<div class="post-body" style="overflow-wrap: break-word;margin-top: 5px;margin-left: 10px;text-align:">
{{i.body}}
</div>
<div class="input-group-btn">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="float: right;background-color: rgba(73, 241, 78, 0.9);border: 0"><span class="glyphicon glyphicon-chevron-down"></span></button>
        <ul class="dropdown-menu">
          <li><button id="delete{{i.id}}" style="float: right;background-color: white;border: 0;color: #f3630b"><span class="glyphicon glyphicon-trash"></span>&nbsp;删除</button></li>
        </ul>
      </div>
  </div>


</div>
{% endif %}
{% endif %}
{% endfor %}
<p id="unread" style="text-align: center;">---------------以上为历史消息---------------</p>
{% else %}
{% for i in fmessgs %}
<script type="text/javascript">
var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
            $(function(){
                $("#delete{{i.id}}").click(function(){
                    var data={
                        data: JSON.stringify({
                            'a': "test"
                        }),
                    }
                    $.ajax({
                        url: $SCRIPT_ROOT + '/delete_message/'+{{i.id}},
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        success:function(data){
                        $("#{{i.id}}").remove();

                        },
                      })
                    })
                })

</script>
{% if i.author_id==contector.id %}
{% if i == unreadmessages[0] %}
<p id="unread{{i.id}}" style="text-align: center;">---------------以下为未读消息---------------</p>
<div id="{{i.id}}">
<div class="post-thumbnail" style="margin-top:23px">
<a href="{{ url_for('.user', username=i.author.username) }}">
{% if i.author.photo %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.photo }}" style="width: 40px; height: 40px; ">
{% else %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.gravatar(size=40)}}">
{% endif %}
</a>
</div>
<div class="contector-time" style="padding-left: 48px">{{ moment(i.timestamp).format('YYYY-M-D, H:mm') }}
</div>
<div class='message-content' style="margin-left: 48px;margin-right: 75%; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color:#f5f5f5">

<div class="post-body" style="overflow-wrap: break-word;margin-left: 10px;margin-top: 5px">

{{i.body}}
</div>
<div class="input-group-btn">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="float: right;background-color: #f5f5f5;border: 0"><span class="glyphicon glyphicon-chevron-down"></span></button>
        <ul class="dropdown-menu">
          <li><button id="delete{{i.id}}" style="float: right;background-color: white;border: 0;color: #f3630b"><span class="glyphicon glyphicon-trash"></span>&nbsp;删除</button></li>
        </ul>
      </div>

</div>
</div>
{% else %}
    {% if not i.sendto_delete %}
<div id="{{i.id}}">
<div class="post-thumbnail" style="margin-top:23px">
<a href="{{ url_for('.user', username=i.author.username) }}">
{% if i.author.photo %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.photo }}" style="width: 40px; height: 40px; ">
{% else %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.gravatar(size=40)}}">
{% endif %}
</a>
</div>
<div class="contector-time" style="padding-left: 48px">{{ moment(i.timestamp).format('YYYY-M-D, H:mm') }}
</div>
<div class='message-content' style="margin-left: 48px;margin-right: 75%; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color:#f5f5f5">

<div class="post-body" style="overflow-wrap: break-word;margin-left: 10px;margin-top: 5px">
{{i.body}}
</div>
<div class="input-group-btn">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="float: right;background-color:#f5f5f5;border: 0"><span class="glyphicon glyphicon-chevron-down"></span></button>
        <ul class="dropdown-menu">
          <li><button id="delete{{i.id}}" style="float: right;background-color: white;border: 0;color: #f3630b"><span class="glyphicon glyphicon-trash"></span>&nbsp;删除</button></li>
        </ul>
      </div>

</div>
</div>
    {% endif %}
{% endif %}
{% endif %}
{% if i.sendto_id==contector.id %}
{% if not i.author_delete %}
<div id="{{i.id}}" style="display: block; margin:0;padding: 0; ">
<div class="post-thumbnail" style="margin-left:87%; margin-top: 23px">
<a href="{{ url_for('.user', username=i.author.username) }}">
{% if i.author.photo %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.photo }}" style="width: 40px; height: 40px; ">
{% else %}
<img class="img-rounded profile-thumbnail" src="{{ i.author.gravatar(size=40)}}">
{% endif %}
</a>
</div>
<div class="contector-time" style="margin-left: 71%;margin-right: ">{{ moment(i.timestamp).format('YYYY-M-D, H:mm') }}
</div>
<div class='message-content' style="margin-left: 75%;margin-right: 50px; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color: rgba(73, 241, 78, 0.9);">

<div class="post-body" style="overflow-wrap: break-word;margin-top: 5px;margin-left: 10px;text-align:">
{{i.body}}
</div>
<div class="input-group-btn">
        <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" style="float: right;background-color: rgba(73, 241, 78, 0.9);border: 0"><span class="glyphicon glyphicon-chevron-down"></span></button>
        <ul class="dropdown-menu">
          <li><button id="delete{{i.id}}" style="float: right;background-color: white;border: 0;color: #f3630b"><span class="glyphicon glyphicon-trash"></span>&nbsp;删除</button></li>
        </ul>
      </div>
</div>
</div>
    {% endif %}
{% endif %}
{% endfor %}
{% endif %}

</li>
<hr>

</ul>
<div id="contectorform" class="comment-form" style="padding-bottom:50px">
<p>
  <input id="body" type="text" name="body" style="width: 98%;height: 27px;border:1px solid #da7f21"></input>
</p>
<button id="submit" style="margin-left: 90%;background-color: #c76d10;color: white;width: 70px;border:1px solid;">回复</button>
</div>
{% endblock %}
{% block scripts %}
{{ super() }}

<script type="text/javascript">
var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
var reloadmessage = {
      url:$SCRIPT_ROOT+'/testmsg/'+{{contector.id}},
      dataType:'json',
      success :function(data1){
        if (data1.result){
          

        if ("{{contector.photo}}" != "None"){
        $('#contectormessages').append("<div id='"+data1.msgid+"'> <div class='post-thumbnail' style='margin-top: 23px' ><a href="+"{{url_for('.user', username=contector.username)}}"+"><img class='img-rounded profile-thumbnail' src='{{ contector.photo }}' style='width: 40px; height: 40px;'></a></div><div class='contector-time' style='padding-left:48px; display: block;'>"+data1.t+"</div><div class='message-content animated fadeIn' style='margin-left: 48px;margin-right: 75%; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color:#f5f5f5'><div class='post-body' style='overflow-wrap: break-word;margin-left: 10px;margin-top: 5px'>"+data1.result+"</div><div class='input-group-btn'><button type='button' class='btn btn-default dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' style='float: right;background-color:#f5f5f5;border: 0'><span class='glyphicon glyphicon-chevron-down'></span></button><ul class='dropdown-menu'><li><button id='delete"+data1.msgid+"' style='float: right;background-color: white;border: 0;color: #f3630b'><span class='glyphicon glyphicon-trash'></span>&nbsp;删除</button></li></ul></div></div></div>");
        $("#delete"+data1.msgid).click(function(){
                    var data={
                        data: JSON.stringify({
                            'a': "test"
                        }),
                    }
                    $.ajax({
                        url: $SCRIPT_ROOT + '/delete_message/'+data1.msgid,
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        success:function(data){
                        $("#"+data1.msgid).remove();

                        },
                      })
                    });
      } else{
        $('#contectormessages').append("<div id='"+data1.msgid+"'><div class='post-thumbnail' style='margin-top: 23px' ><a href="+"{{url_for('.user', username=contector.username)}}"+"><img class='img-rounded profile-thumbnail' src='{{ contector.gravatar(size=40)}}'></a></div><div class='contector-time' style='padding-left:48px; display: block;'>"+data1.t+"</div><div class='message-content animated fadeIn' style='margin-left: 48px;margin-right: 75%; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color:#f5f5f5'><div class='post-body' style='overflow-wrap: break-word;margin-left: 10px;margin-top: 5px'>"+data1.result+"</div><div class='input-group-btn'><button type='button' class='btn btn-default dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' style='float: right;background-color:#f5f5f5;border: 0'><span class='glyphicon glyphicon-chevron-down'></span></button><ul class='dropdown-menu'><li><button id='delete"+data1.msgid+"' style='float: right;background-color: white;border: 0;color: #f3630b'><span class='glyphicon glyphicon-trash'></span>&nbsp;删除</button></li></ul></div></div></div>");
         $("#delete"+data1.msgid).click(function(){
                    var data={
                        data: JSON.stringify({
                            'a': "test"
                        }),
                    }
                    $.ajax({
                        url: $SCRIPT_ROOT + '/delete_message/'+data1.msgid,
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        success:function(data){
                        $("#"+data1.msgid).remove();

                        },
                      })
                    });
      }
      };
    }
      };
window.setInterval(function(){$.ajax(reloadmessage)},1000);
</script>
<script type="text/javascript">
 var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
            $(function(){
                $("#submit").click(function(){
                    var a=$('input[name="body"]').val();
                    var data={
                        data: JSON.stringify({
                            'a': a
                        }),
                    }
                    $.ajax({
                        url: $SCRIPT_ROOT + '/remsg/'+{{ contector.id }},
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        success:function(data1){
                          $('input[name="body"]').val("")
                          if (data1.result){
                          if("{{current_user.photo}}" != "None"){
                            
                            $('#contectormessages').append("<div id='"+data1.msgid+"' style='display: block; margin:0;padding: 0;'><div class='post-thumbnail' style='margin-left:87%;margin-top: 23px' ><a href="+"{{url_for('.user', username=current_user.username)}}"+"><img class='img-rounded profile-thumbnail' src='{{ current_user.photo }}' style='width: 40px; height: 40px;'></a></div><div class='contector-time' style='margin-left: 80%'>"+data1.t+"</div><div class='message-content animated fadeIn' style='margin-left: 75%;margin-right: 50px; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color: rgba(73, 241, 78, 0.9);'><div class='post-body' style='overflow-wrap: break-word;margin-top: 5px;margin-left: 10px;text-align:'>"+data1.result+"</div><div class='input-group-btn'><button type='button' class='btn btn-default dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' style='float: right;background-color: rgba(73, 241, 78, 0.9);border: 0'><span class='glyphicon glyphicon-chevron-down'></span></button><ul class='dropdown-menu'><li><button id='delete"+data1.msgid+"' style='float: right;background-color: white;border: 0;color: #f3630b'><span class='glyphicon glyphicon-trash'></span>&nbsp;删除</button></li></ul></div></div></div>");
                            $("#delete"+data1.msgid).click(function(){
                    var data={
                        data: JSON.stringify({
                            'a': "test"
                        }),
                    }
                    $.ajax({
                        url: $SCRIPT_ROOT + '/delete_message/'+data1.msgid,
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        success:function(data){
                        $("#"+data1.msgid).remove();

                        },
                      })
                    });
                          } else{
                            $('#contectormessages').append("<div id='"+data1.msgid+"' style='display: block; margin:0;padding: 0;'><div class='post-thumbnail' style='margin-left:87%;margin-top: 23px' ><a href="+"{{url_for('.user', username=current_user.username)}}"+"><img class='img-rounded profile-thumbnail' src='{{ current_user.gravatar(size=40)}}'></a></div><div class='contector-time' style='margin-left: 80%'>"+data1.t+"</div><div class='message-content animated fadeIn' style='margin-left: 75%;margin-right: 50px; min-height: 48px;border:1px;border-radius: 10px;margin-bottom: 3px;background-color: rgba(73, 241, 78, 0.9);'><div class='post-body' style='overflow-wrap: break-word;margin-top: 5px;margin-left: 10px;text-align:'>"+data1.result+"</div><div class='input-group-btn'><button type='button' class='btn btn-default dropdown-toggle' data-toggle='dropdown' aria-haspopup='true' aria-expanded='false' style='float: right;background-color: rgba(73, 241, 78, 0.9);border: 0'><span class='glyphicon glyphicon-chevron-down'></span></button><ul class='dropdown-menu'><li><button id='delete"+data1.msgid+"' style='float: right;background-color: white;border: 0;color: #f3630b'><span class='glyphicon glyphicon-trash'></span>&nbsp;删除</button></li></ul></div></div></div>");
                            $("#delete"+data1.msgid).click(function(){
                    var data={
                        data: JSON.stringify({
                            'a': "test"
                        }),
                    }
                    $.ajax({
                        url: $SCRIPT_ROOT + '/delete_message/'+data1.msgid,
                        type: 'POST',
                        dataType: 'json',
                        data: data,
                        success:function(data){
                        $("#"+data1.msgid).remove();

                        },
                      })
                    });
                          }
                        }

                        },
                      })
                    })
                })
</script>

{% endblock %}